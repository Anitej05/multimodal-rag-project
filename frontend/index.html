<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Multimodal RAG - Knowledge Base Assistant</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-50: #eaf3ff;
      --primary: #2563eb; /* a professional blue */
      --primary-600: #1e40af;
      --accent: #7c3aed;
      --bg-1: #071028; /* deep navy */
      --bg-2: #0f1724; /* dark blue-gray */
      --card: rgba(255,255,255,0.03);
      --muted: #94a3b8;
      --muted-2: #7b8794;
      --glass: rgba(255,255,255,0.03);
      --border: rgba(255,255,255,0.06);
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --radius: 14px;
      --radius-sm: 8px;
      --shadow-lg: 0 18px 40px rgba(2,6,23,0.6);
      --shadow-md: 0 8px 20px rgba(2,6,23,0.45);
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      color-scheme: dark;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body { height: 100%; }

    body {
      background: radial-gradient(1200px 400px at 10% 10%, rgba(124,58,237,0.08), transparent 8%),
                  linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 100%);
      color: #e6eef8;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
      line-height: 1.6;
      padding-bottom: 40px;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 90;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      padding: 18px 28px;
      box-shadow: var(--shadow-md);
    }

    .header-content {
      max-width: 1360px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 20px;
      justify-content: space-between;
    }

    .header h1 {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
      letter-spacing: -0.02em;
      color: white;
    }

    .logo-dot {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      box-shadow: 0 6px 18px rgba(37,99,235,0.2), inset 0 -6px 16px rgba(255,255,255,0.04);
      font-size: 18px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.03);
      color: var(--muted);
      font-weight: 600;
      font-size: 13px;
      min-width: 120px;
      justify-content: center;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 6px 12px rgba(16,185,129,0.15);
      animation: subtlePulse 2.4s infinite;
    }

    @keyframes subtlePulse { 0% { transform: scale(1); opacity: 1 } 50% { transform: scale(1.12); opacity: 0.75 } 100% { transform: scale(1); opacity: 1 } }

    /* Layout */
    .container {
      max-width: 1360px;
      margin: 26px auto;
      padding: 0 28px;
      display: grid;
      grid-template-columns: 1fr 560px;
      gap: 28px;
      align-items: start;
    }

    /* Card base */
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 26px;
      box-shadow: var(--shadow-lg);
      transition: transform 0.18s ease, box-shadow 0.18s ease;
    }

    .card:hover { transform: translateY(-6px); }

    .card-header { display:flex; justify-content: space-between; align-items:center; margin-bottom: 18px; }

    .card-title { font-size: 18px; font-weight: 700; color: #f1f7ff; display:flex; gap:10px; align-items:center; }

    .card-icon { width:36px; height:36px; display:grid; place-items:center; border-radius:10px; background: linear-gradient(135deg, rgba(37,99,235,0.12), rgba(124,58,237,0.08)); font-size:16px; }

    /* Tabs */
    .tabs { display:flex; gap:8px; background: rgba(255,255,255,0.01); padding:6px; border-radius: 12px; align-items:center; }

    .tab { padding:10px 16px; border-radius: 10px; background: transparent; border: none; color: var(--muted); font-weight: 700; cursor: pointer; font-size: 13px; transition: all 0.18s; }
    .tab:hover { color: #fff; transform: translateY(-2px); }
    .tab.active { background: linear-gradient(90deg, rgba(37,99,235,0.14), rgba(124,58,237,0.06)); color: white; box-shadow: 0 8px 26px rgba(2,6,23,0.5); }

    /* Upload area */
    .upload-zone { border-radius: 12px; padding: 36px; text-align: center; border: 2px dashed rgba(255,255,255,0.04); cursor:pointer; background: linear-gradient(180deg, rgba(255,255,255,0.008), transparent); transition: all 0.16s ease; }
    .upload-zone:hover { transform: translateY(-4px); border-color: rgba(37,99,235,0.35); box-shadow: 0 8px 30px rgba(37,99,235,0.06); }
    .upload-icon { font-size: 50px; margin-bottom: 12px; opacity: 0.9; }
    .upload-text { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
    .upload-hint { font-size: 13px; color: var(--muted-2); }

    /* Stats */
    .file-stats { display:grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-top: 22px; }
    .stat-card { background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.006)); padding:14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.02); text-align:center; }
    .stat-value { font-size: 22px; font-weight: 800; color: var(--primary); display:block; }
    .stat-label { font-size: 12px; color: var(--muted-2); margin-top:6px; letter-spacing: 0.06em; text-transform: uppercase; }

    /* Controls */
    .controls { display:flex; gap:12px; margin-top: 18px; }
    .btn { padding:12px 18px; border-radius: 10px; border: none; font-weight: 700; cursor:pointer; display:inline-flex; gap:10px; align-items:center; justify-content:center; }
    .btn-primary { background: linear-gradient(90deg, var(--primary), var(--primary-600)); color: white; box-shadow: 0 10px 30px rgba(37,99,235,0.12); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-secondary { background: transparent; color: #eaf3ff; border: 1px solid rgba(255,255,255,0.04); }
    .btn-icon { width:44px; height:44px; padding:0; border-radius:10px; }

    /* File list */
    .file-list { max-height: 420px; overflow-y: auto; margin-top: 12px; padding-right: 6px; }
    .file-list::-webkit-scrollbar { width:8px; }
    .file-list::-webkit-scrollbar-thumb { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border-radius:8px; }

    .file-item { display:flex; gap:14px; align-items:center; padding:12px; border-radius:10px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.006)); margin-bottom:10px; border: 1px solid transparent; transition: all 0.16s; }
    .file-item:hover { transform: translateX(6px); border-color: rgba(37,99,235,0.22); box-shadow: 0 10px 30px rgba(2,6,23,0.45); }

    .file-preview { width:60px; height:60px; border-radius: 10px; display:grid; place-items:center; font-size:20px; background: linear-gradient(180deg, rgba(16,24,40,0.6), rgba(255,255,255,0.02)); overflow:hidden; flex-shrink:0; }
    .file-preview img { width:100%; height:100%; object-fit:cover; display:block; }

    .file-info { flex:1; min-width: 0; }
    .file-name { font-weight: 700; font-size: 14px; color: #eef6ff; margin-bottom:6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .file-meta { font-size: 12px; color: var(--muted-2); display:flex; gap:10px; align-items:center; }

    .file-status { padding:6px 10px; border-radius: 999px; font-weight:800; font-size:11px; text-transform:uppercase; letter-spacing:0.06em; }
    .status-pending { background: rgba(245,158,11,0.12); color: var(--warning); }
    .status-indexed { background: rgba(16,185,129,0.12); color: var(--success); }
    .status-error { background: rgba(239,68,68,0.12); color: var(--danger); }

    /* Chat */
    .chat-container { display:flex; flex-direction:column; height: calc(100vh - 210px); max-height: 840px; }
    .chat-messages { flex:1; overflow-y:auto; padding:18px; border-radius: 10px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.008)); border: 1px solid rgba(255,255,255,0.02); }

    .message { margin-bottom:14px; display:flex; gap:12px; align-items:flex-start; }
    .message-avatar { width:44px; height:44px; border-radius:10px; display:grid; place-items:center; font-weight:700; }
    .message-user .message-avatar { background: linear-gradient(135deg, var(--primary), var(--primary-600)); }
    .message-assistant .message-avatar { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03); }

    .message-content { max-width: 86%; }
    .message-bubble { padding:14px 16px; border-radius: 12px; line-height:1.55; font-size:14px; }
    .message-user .message-bubble { background: linear-gradient(90deg, var(--primary), var(--primary-600)); color: white; border-radius: 12px 12px 6px 12px; }
    .message-assistant .message-bubble { background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.006)); border:1px solid rgba(255,255,255,0.02); color: #e6eef8; border-radius: 12px 12px 12px 6px; }

    .message-time { font-size:11px; color: var(--muted-2); margin-top:6px; padding-left:4px; }

    /* Typing / loading */
    .loading-spinner { width:18px; height:18px; border-radius:50%; border:3px solid rgba(255,255,255,0.06); border-top-color: var(--primary); animation: spin 0.9s linear infinite; display:inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Chat input */
    .chat-input-container { margin-top:12px; border-radius: 12px; padding:14px; border: 1px solid rgba(255,255,255,0.02); background: linear-gradient(180deg, rgba(255,255,255,0.008), transparent); }
    .chat-input-wrapper { display:flex; gap:12px; align-items:flex-end; }
    .chat-input { flex:1; background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.02); padding:12px 14px; border-radius: 10px; color: #eaf3ff; resize:none; max-height: 140px; font-family:inherit; font-size:14px; }
    .chat-input::placeholder { color: var(--muted-2); }

    .input-actions { display:flex; gap:8px; margin-top:10px; }
    .recording { animation: pulseRecord 1.6s infinite; }
    @keyframes pulseRecord { 0% { transform: scale(1); } 50% { transform: scale(0.98); } 100% { transform: scale(1); } }

    /* Empty state */
    .empty-state { text-align:center; padding:40px 20px; color: var(--muted-2); }
    .empty-icon { font-size:56px; margin-bottom:14px; opacity:0.35; }
    .empty-text { font-size:16px; font-weight:700; color:#dff0ff; }

    /* Toast */
    .toast { position: fixed; bottom: 30px; right: 30px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.006)); border:1px solid rgba(255,255,255,0.03); padding:12px 16px; border-radius:10px; box-shadow: 0 18px 40px rgba(2,6,23,0.6); z-index: 1200; }

    /* Responsive */
    @media (max-width: 1100px) { .container { grid-template-columns: 1fr; padding: 0 20px; } .chat-container { max-height: 680px; height: auto; } }
    @media (max-width: 700px) { .header h1 { font-size: 16px; } .logo-dot { width:38px; height:38px; } .file-preview { width:52px; height:52px; } }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <h1>
        <span class="logo-dot">üß†</span>
        <span>Multimodal RAG Assistant</span>
      </h1>
      </div>
  </header>

  <main class="container">
    <!-- Left Column -->
    <div>
      <!-- Knowledge Base Card -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <div class="card-icon">üìö</div>
            Knowledge Base
          </div>
        </div>

        <div class="tabs">
          <button class="tab active" data-tab="upload">üì§ Upload</button>
          <button class="tab" data-tab="files">üìÅ Files</button>
        </div>

        <!-- Upload Tab -->
        <div class="tab-content" data-content="upload">
          <div class="upload-zone" id="upload-zone">
            <div class="upload-icon">‚òÅÔ∏è</div>
            <div class="upload-text">Drop files here or click to browse</div>
            <div class="upload-hint">Supports: PDF, TXT, DOCX, CSV, PNG, JPG, MP3, WAV, M4A</div>
            <input type="file" id="file-input" class="file-input-hidden" multiple />
          </div>

          <div class="file-stats">
            <div class="stat-card">
              <span class="stat-value" id="total-files">0</span>
              <span class="stat-label">Total Files</span>
            </div>
            <div class="stat-card">
              <span class="stat-value" id="indexed-files">0</span>
              <span class="stat-label">Indexed</span>
            </div>
            <div class="stat-card">
              <span class="stat-value" id="total-size">0 MB</span>
              <span class="stat-label">Total Size</span>
            </div>
          </div>

          <div class="controls">
            <button class="btn btn-primary" id="index-btn">
              <span>üöÄ</span>
              <span>Index Knowledge Base</span>
            </button>
            <button class="btn btn-secondary" id="reset-btn">
              <span>üîÑ</span>
              <span>Reset</span>
            </button>
          </div>
        </div>

        <!-- Files Tab -->
        <div class="tab-content" data-content="files" style="display:none">
          <div id="file-list-container"></div>
        </div>
      </div>
    </div>

    <!-- Right Column - Chat -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <div class="card-icon">üí¨</div>
          AI Assistant
        </div>
      </div>

      <div class="chat-container">
        <div class="chat-messages" id="chat-messages">
          <div class="empty-state">
            <div class="empty-icon">ü§ñ</div>
            <div class="empty-text">Start a conversation</div>
            <div style="font-size: 13px; margin-top: 4px;">Ask questions about your uploaded documents, images, or audio files</div>
          </div>
        </div>

        <div class="chat-input-container">
          <div class="chat-input-wrapper">
            <textarea 
              id="chat-input" 
              class="chat-input" 
              placeholder="Ask anything about your knowledge base..." 
              rows="1"
            ></textarea>
            <button class="btn btn-primary btn-icon" id="send-btn" title="Send message">
              <span>üì§</span>
            </button>
          </div>
          <div class="input-actions">
            <label class="btn btn-secondary btn-icon" title="Attach audio file">
              <input type="file" id="audio-input" accept="audio/*" style="display:none" />
              <span>üé§</span>
            </label>
            <button class="btn btn-secondary btn-icon" id="record-btn" title="Record audio">
              <span>‚è∫Ô∏è</span>
            </button>
            <button class="btn btn-secondary btn-icon" id="clear-chat-btn" title="Clear chat">
              <span>üóëÔ∏è</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // API Module
    const API_BASE_URL = 'http://127.0.0.1:8000';

    const api = {
      async ingestFiles(files) {
        const fd = new FormData();
        for (const f of files) fd.append('files', f);
        const res = await fetch(`${API_BASE_URL}/ingest`, { method: 'POST', body: fd });
        if (!res.ok) throw new Error(`Ingest failed: ${res.statusText}`);
        return res.json();
      },
      async chatText(query) {
        const res = await fetch(`${API_BASE_URL}/chat`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ query })
        });
        if (!res.ok) throw new Error(`Chat failed: ${res.statusText}`);
        return res.json();
      },
      async chatAudio(file) {
        const fd = new FormData();
        fd.append('file', file);
        const res = await fetch(`${API_BASE_URL}/chat-audio`, { method: 'POST', body: fd });
        if (!res.ok) throw new Error(`Chat audio failed: ${res.statusText}`);
        return res.json();
      },
      async resetKB() {
        const res = await fetch(`${API_BASE_URL}/reset`, { method: 'POST' });
        if (!res.ok) throw new Error(`Reset failed: ${res.statusText}`);
        return res.json();
      }
    };

    // State
    let uploadedFiles = [];
    let recorder = null;
    let recordedChunks = [];

    // DOM Elements
    const fileInput = document.getElementById('file-input');
    const uploadZone = document.getElementById('upload-zone');
    const indexBtn = document.getElementById('index-btn');
    const resetBtn = document.getElementById('reset-btn');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const audioInput = document.getElementById('audio-input');
    const recordBtn = document.getElementById('record-btn');
    const clearChatBtn = document.getElementById('clear-chat-btn');

    // Utility Functions
    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function getFileIcon(type) {
      if (type.startsWith('image/')) return 'üñºÔ∏è';
      if (type.startsWith('audio/')) return 'üéµ';
      if (type.includes('pdf')) return 'üìÑ';
      if (type.includes('word') || type.includes('docx')) return 'üìù';
      if (type.includes('csv') || type.includes('excel')) return 'üìä';
      if (type.includes('text')) return 'üìÉ';
      return 'üìé';
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function updateStats() {
      document.getElementById('total-files').textContent = uploadedFiles.length;
      document.getElementById('indexed-files').textContent = uploadedFiles.filter(f => f.status === 'indexed').length;
      const totalSize = uploadedFiles.reduce((sum, f) => sum + f.size, 0);
      document.getElementById('total-size').textContent = formatBytes(totalSize);
    }

    function renderFileList() {
      const container = document.getElementById('file-list-container');
      if (uploadedFiles.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìÅ</div><div class="empty-text">No files uploaded yet</div></div>';
        return;
      }

      container.innerHTML = '<div class="file-list">' + uploadedFiles.map(f => `
        <div class="file-item">
          ${f.previewUrl 
            ? `<img src="${f.previewUrl}" class="file-preview" alt="${f.name}" />`
            : `<div class="file-preview">${getFileIcon(f.type)}</div>`
          }
          <div class="file-info">
            <div class="file-name">${escapeHtml(f.name)}</div>
            <div class="file-meta">
              <span>${formatBytes(f.size)}</span>
              <span>‚Ä¢</span>
              <span>${f.type.split('/')[1] || 'unknown'}</span>
            </div>
          </div>
          <div class="file-status status-${f.status}">${f.status}</div>
        </div>
      `).join('') + '</div>';
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function addMessage(text, isUser = false) {
      const isEmpty = chatMessages.querySelector('.empty-state');
      if (isEmpty) isEmpty.remove();

      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const message = document.createElement('div');
      message.className = `message ${isUser ? 'message-user' : 'message-assistant'}`;
      message.innerHTML = `
        <div class="message-avatar">${isUser ? 'üë§' : 'ü§ñ'}</div>
        <div class="message-content">
          <div class="message-bubble">${escapeHtml(text).replace(/\n/g, '<br>')}</div>
          <div class="message-time">${time}</div>
        </div>
      `;
      chatMessages.appendChild(message);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Tab Navigation
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        tab.classList.add('active');
        document.querySelector(`[data-content="${tabName}"]`).style.display = 'block';
      });
    });

    // File Upload
    uploadZone.addEventListener('click', () => fileInput.click());
    
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('drag-over');
    });
    
    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('drag-over');
    });
    
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('drag-over');
      const files = Array.from(e.dataTransfer.files);
      handleFiles(files);
    });

    fileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files || []);
      handleFiles(files);
    });

    function handleFiles(files) {
      if (files.length === 0) return;
      
      files.forEach(f => {
        const id = Date.now().toString() + Math.random().toString(36).slice(2, 9);
        const previewUrl = f.type.startsWith('image/') ? URL.createObjectURL(f) : null;
        uploadedFiles.push({
          id,
          file: f,
          name: f.name,
          type: f.type || 'application/octet-stream',
          size: f.size,
          status: 'pending',
          previewUrl
        });
      });
      
      updateStats();
      renderFileList();
      showToast(`${files.length} file(s) added`, 'success');
    }

    // Index Knowledge Base
    indexBtn.addEventListener('click', async () => {
      if (uploadedFiles.length === 0) {
        showToast('No files to index. Please upload files first.', 'error');
        return;
      }

      indexBtn.disabled = true;
      indexBtn.innerHTML = '<span class="loading-spinner"></span><span>Indexing...</span>';

      try {
        const filesToSend = uploadedFiles.map(f => f.file);
        const result = await api.ingestFiles(filesToSend);
        uploadedFiles = uploadedFiles.map(u => ({ ...u, status: 'indexed' }));
        updateStats();
        renderFileList();
        showToast(`Successfully indexed ${uploadedFiles.length} file(s)`, 'success');
        addMessage(`‚úÖ Indexed ${uploadedFiles.length} file(s) into the knowledge base. You can now ask questions about your documents.`, false);
      } catch (err) {
        console.error(err);
        showToast(`Indexing failed: ${err.message}`, 'error');
        addMessage(`‚ùå Indexing error: ${err.message}`, false);
      } finally {
        indexBtn.disabled = false;
        indexBtn.innerHTML = '<span>üöÄ</span><span>Index Knowledge Base</span>';
      }
    });

    // Reset Knowledge Base
    resetBtn.addEventListener('click', async () => {
      if (uploadedFiles.length === 0) {
        showToast('Knowledge base is already empty', 'info');
        return;
      }

      if (!confirm('‚ö†Ô∏è This will clear the entire knowledge base. Are you sure?')) return;

      try {
        await api.resetKB();
        uploadedFiles = [];
        updateStats();
        renderFileList();
        showToast('Knowledge base reset successfully', 'success');
        addMessage('üîÑ Knowledge base has been reset.', false);
      } catch (err) {
        console.error(err);
        showToast(`Reset failed: ${err.message}`, 'error');
      }
    });

    // Chat - Send Message
    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    async function sendMessage() {
      const text = chatInput.value.trim();
      const audioFile = audioInput.files && audioInput.files[0];

      if (!text && !audioFile) {
        showToast('Please enter a message or attach an audio file', 'error');
        return;
      }

      if (audioFile) {
        addMessage('üé§ [Audio message]', true);
        chatInput.value = '';
        audioInput.value = '';

        try {
          const res = await api.chatAudio(audioFile);
          addMessage(res.answer || res.response || 'No response from assistant', false);
        } catch (err) {
          console.error(err);
          addMessage(`‚ùå Audio chat error: ${err.message}`, false);
          showToast(`Audio chat failed: ${err.message}`, 'error');
        }
        return;
      }

      addMessage(text, true);
      chatInput.value = '';
      
      // Show typing indicator
      const typingId = 'typing-' + Date.now();
      const typingMsg = document.createElement('div');
      typingMsg.id = typingId;
      typingMsg.className = 'message message-assistant';
      typingMsg.innerHTML = `
        <div class="message-avatar">ü§ñ</div>
        <div class="message-content">
          <div class="message-bubble">
            <span class="loading-spinner"></span>
            <span style="margin-left: 8px;">Thinking...</span>
          </div>
        </div>
      `;
      chatMessages.appendChild(typingMsg);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      try {
        const res = await api.chatText(text);
        document.getElementById(typingId)?.remove();
        addMessage(res.answer || res.response || 'No response from assistant', false);
      } catch (err) {
        console.error(err);
        document.getElementById(typingId)?.remove();
        addMessage(`‚ùå Error: ${err.message}`, false);
        showToast(`Chat failed: ${err.message}`, 'error');
      }
    }

    // Audio Input
    audioInput.addEventListener('change', () => {
      if (audioInput.files && audioInput.files[0]) {
        showToast('Audio file attached. Click Send to submit.', 'info');
      }
    });

    // Record Audio
    recordBtn.addEventListener('click', async () => {
      if (recorder && recorder.state === 'recording') {
        recorder.stop();
        recordBtn.classList.remove('recording');
        recordBtn.innerHTML = '<span>‚è∫Ô∏è</span>';
        showToast('Recording stopped', 'info');
        return;
      }

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showToast('Recording not supported in this browser', 'error');
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recordedChunks = [];
        recorder = new MediaRecorder(stream);
        
        recorder.ondataavailable = (ev) => {
          if (ev.data && ev.data.size) recordedChunks.push(ev.data);
        };
        
        recorder.onstop = () => {
          stream.getTracks().forEach(track => track.stop());
          const blob = new Blob(recordedChunks, { type: 'audio/webm' });
          const file = new File([blob], `recording_${Date.now()}.webm`, { type: 'audio/webm' });
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          audioInput.files = dataTransfer.files;
          showToast('Recording ready! Click Send to submit.', 'success');
        };
        
        recorder.start();
        recordBtn.classList.add('recording');
        recordBtn.innerHTML = '<span>‚èπÔ∏è</span>';
        showToast('Recording started...', 'info');
      } catch (err) {
        console.error(err);
        showToast(`Microphone access denied: ${err.message}`, 'error');
      }
    });

    // Clear Chat
    clearChatBtn.addEventListener('click', () => {
      if (!confirm('Clear all chat messages?')) return;
      chatMessages.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">ü§ñ</div>
          <div class="empty-text">Start a conversation</div>
          <div style="font-size: 13px; margin-top: 4px;">Ask questions about your uploaded documents, images, or audio files</div>
        </div>
      `;
      showToast('Chat cleared', 'info');
    });

    // Auto-resize textarea
    chatInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // Initialize
    updateStats();
    renderFileList();
  </script>
</body>
</html>
